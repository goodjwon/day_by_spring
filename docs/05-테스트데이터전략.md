# í…ŒìŠ¤íŠ¸ ë°ì´í„° ê´€ë¦¬ ì „ëµ

## ğŸ¯ ë¬¸ì œ ì¸ì‹

### ê¸°ì¡´ í…ŒìŠ¤íŠ¸ì˜ ë¬¸ì œì 
1. **data.sql ì˜ì¡´ì„±**: ê¸°ë³¸ ë°ì´í„°ì— ì˜ì¡´í•˜ì—¬ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆì•ˆì •
2. **ë°ì´í„° ê²©ë¦¬ ë¶€ì¡±**: í…ŒìŠ¤íŠ¸ ê°„ ë°ì´í„° ê°„ì„­ìœ¼ë¡œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ê²°ê³¼
3. **ìƒìœ„ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸ ì–´ë ¤ì›€**: ê¸°ë³¸ ë°ì´í„°ê°€ í•„ìš”í•œ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸ ë³µì¡ë„ ì¦ê°€
4. **í…ŒìŠ¤íŠ¸ ì›ì‹œì„± ë¶€ì¡±**: í…ŒìŠ¤íŠ¸ê°€ ì™¸ë¶€ ìš”ì¸ì— ì˜í–¥ë°›ì•„ ì‹ ë¢°ë„ ì €í•˜

## ğŸ—ï¸ í•´ê²° ì „ëµ

### 1. ê³„ì¸µí™”ëœ í…ŒìŠ¤íŠ¸ ë°ì´í„° ê´€ë¦¬

#### 1.1 TestDataBuilder íŒ¨í„´
```java
@TestConfiguration
public class TestDataConfig {
    @Bean
    public TestDataBuilder testDataBuilder() {
        return new TestDataBuilder();
    }
    
    public static class TestDataBuilder {
        // ì—”í‹°í‹°ë³„ ê¸°ë³¸/ì»¤ìŠ¤í…€ ìƒì„± ë©”ì„œë“œ
        public Member createDefaultMember() { ... }
        public Member createMember(String name, String email, MembershipType type) { ... }
        public Book createBook(String title, String author, ...) { ... }
    }
}
```

**ì¥ì :**
- ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
- ì¼ê´€ëœ ë°ì´í„° êµ¬ì¡° ë³´ì¥
- í…ŒìŠ¤íŠ¸ë³„ í•„ìš” ë°ì´í„°ë§Œ ì„ íƒì  ìƒì„±

#### 1.2 TestScenario íŒ¨í„´
```java
public class TestScenario {
    // ì‹œë‚˜ë¦¬ì˜¤ë³„ ë°ì´í„° ì»¨í…Œì´ë„ˆ
    public static class LoanScenario {
        private final Member regularMember;    // 5ê¶Œ ì œí•œ
        private final Member premiumMember;    // 10ê¶Œ ì œí•œ
        private final Member suspendedMember;  // ëŒ€ì—¬ ë¶ˆê°€
        private final Book availableBook;
        private final List<Loan> existingLoans; // ì œí•œ í…ŒìŠ¤íŠ¸ìš©
    }
}
```

**ì¥ì :**
- ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ë³„ ë°ì´í„° ê·¸ë£¹í™”
- ë³µì¡í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ë‹¨ìˆœí™”
- í…ŒìŠ¤íŠ¸ ì˜ë„ ëª…í™•í™”

#### 1.3 TestDataManager
```java
@Component
public class TestDataManager {
    public TestScenario.LoanScenario createLoanScenario(TestEntityManager entityManager) {
        // ëŒ€ì—¬ ê´€ë ¨ ëª¨ë“  í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì¼ê´„ ìƒì„±
        // íšŒì›(3ì¢…ë¥˜) + ë„ì„œ(2ì¢…ë¥˜) + ê¸°ì¡´ëŒ€ì—¬(4ê°œ)
    }
}
```

**ì¥ì :**
- ë³µì¡í•œ ë°ì´í„° ê´€ê³„ ìë™ êµ¬ì„±
- í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë³„ ìµœì í™”ëœ ë°ì´í„° ì œê³µ
- í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ë°ì´í„° ìƒì„± ë¡œì§ ë¶„ë¦¬

### 2. í…ŒìŠ¤íŠ¸ ê²©ë¦¬ ì „ëµ

#### 2.1 @Transactional + @Rollback
```java
@DataJpaTest  // ìë™ìœ¼ë¡œ @Transactional + @Rollback
class MemberRepositoryTest {
    // ê° í…ŒìŠ¤íŠ¸ ë©”ì„œë“œ í›„ ìë™ ë¡¤ë°±
}
```

#### 2.2 ê³ ìœ  ë°ì´í„° ìƒì„±
```java
@Test
void findByEmail_ì¡´ì¬í•˜ëŠ”ì´ë©”ì¼_íšŒì›ë°˜í™˜() {
    // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í™œìš©í•œ ê³ ìœ  ë°ì´í„°
    String uniqueEmail = "test." + System.currentTimeMillis() + "@example.com";
    Member member = testDataBuilder.createMember("í…ŒìŠ¤íŠ¸", uniqueEmail, REGULAR);
    // ...
}
```

#### 2.3 í…ŒìŠ¤íŠ¸ë³„ ë…ë¦½ì  ë°ì´í„° ìƒì„±
```java
@Test
void checkLoanLimit_RegularíšŒì›_5ê¶Œì œí•œí™•ì¸() {
    // data.sqlê³¼ ë¬´ê´€í•˜ê²Œ í•„ìš”í•œ ë°ì´í„°ë§Œ ìƒì„±
    TestScenario.LoanScenario scenario = testDataManager.createLoanScenario(entityManager);
    // ì™„ì „íˆ ë…ë¦½ì ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
}
```

### 3. data.sql í™œìš© ì „ëµ

#### 3.1 data.sql ì—­í•  ì¬ì •ì˜
- **ëª©ì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ê¸°ë³¸ ë°ì´í„° ì œê³µ
- **ë²”ìœ„**: ê°œë°œ/ë°ëª¨ í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©
- **í…ŒìŠ¤íŠ¸ì™€ì˜ ê´€ê³„**: í…ŒìŠ¤íŠ¸ëŠ” data.sqlì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ

#### 3.2 í”„ë¡œíŒŒì¼ë³„ ë¶„ë¦¬
```yaml
# application-test.yml
spring:
  sql:
    init:
      mode: never  # í…ŒìŠ¤íŠ¸ ì‹œ data.sql ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
  jpa:
    defer-datasource-initialization: false
```

```yaml
# application-dev.yml  
spring:
  sql:
    init:
      mode: always  # ê°œë°œ ì‹œì—ëŠ” data.sql ì‹¤í–‰
```

## ğŸ” êµ¬ì²´ì  ì ìš© ì‚¬ë¡€

### Case 1: Repository í…ŒìŠ¤íŠ¸

#### âŒ ê¸°ì¡´ ë°©ì‹ (data.sql ì˜ì¡´)
```java
@Test
void findByMembershipType_REGULAR_íšŒì›ì¡°íšŒ() {
    List<Member> members = memberRepository.findByMembershipType(REGULAR);
    assertThat(members).hasSize(2); // data.sqlì— REGULAR 2ëª…ì´ ìˆë‹¤ê³  ê°€ì •
}
```
**ë¬¸ì œì :** data.sql ë³€ê²½ ì‹œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

#### âœ… ê°œì„ ëœ ë°©ì‹ (ë…ë¦½ì  ë°ì´í„°)
```java
@Test  
void findByMembershipType_REGULAR_íšŒì›ì¡°íšŒ() {
    // Given - í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ë§Œ ìƒì„±
    Member regular1 = testDataBuilder.createMember("ì •ê·œ1", "r1@test.com", REGULAR);
    Member regular2 = testDataBuilder.createMember("ì •ê·œ2", "r2@test.com", REGULAR);
    Member premium = testDataBuilder.createPremiumMember("í”„ë¦¬ë¯¸ì—„", "p@test.com");
    
    entityManager.persist(regular1);
    entityManager.persist(regular2);  
    entityManager.persist(premium);
    entityManager.flush();
    
    // When
    List<Member> members = memberRepository.findByMembershipType(REGULAR);
    
    // Then - ì •í™•íˆ ìƒì„±í•œ 2ëª…ë§Œ í™•ì¸
    assertThat(members)
        .extracting(Member::getName)
        .contains("ì •ê·œ1", "ì •ê·œ2")
        .doesNotContain("í”„ë¦¬ë¯¸ì—„");
}
```

### Case 2: Service í…ŒìŠ¤íŠ¸ (ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

#### âœ… ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ í…ŒìŠ¤íŠ¸
```java
@Test
void loanBook_RegularíšŒì›5ê¶Œì œí•œ_ì´ˆê³¼ì‹œì˜ˆì™¸ë°œìƒ() {
    // Given - ì´ë¯¸ 4ê¶Œ ëŒ€ì—¬ ì¤‘ì¸ ìƒí™© ì‹œë‚˜ë¦¬ì˜¤
    TestScenario.LoanScenario scenario = testDataManager.createLoanScenario(entityManager);
    
    assertThat(scenario.getRegularMemberLoanCount()).isEqualTo(4);
    assertThat(scenario.isRegularMemberNearLimit()).isTrue();
    
    // When & Then - 5ë²ˆì§¸ëŠ” ì„±ê³µ, 6ë²ˆì§¸ë¶€í„° ì‹¤íŒ¨
    // ... ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸
}
```

### Case 3: í†µí•© í…ŒìŠ¤íŠ¸

#### âœ… ë³µí•© ì‹œë‚˜ë¦¬ì˜¤ í™œìš©
```java
@Test
void íšŒì›ê°€ì…ë¶€í„°ëŒ€ì—¬ê¹Œì§€_ì „ì²´í”Œë¡œìš°_ì •ìƒë™ì‘() {
    // Given - ë³µí•© ì‹œë‚˜ë¦¬ì˜¤ (íšŒì›+ë„ì„œ+ê¸°ì¡´ëŒ€ì—¬+ì£¼ë¬¸)
    TestScenario.ComplexScenario scenario = testDataManager.createComplexScenario(entityManager);
    
    // When & Then - ì „ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
    // 1. ì‹ ê·œ íšŒì› ë“±ë¡
    // 2. ë„ì„œ ëŒ€ì—¬
    // 3. ì œí•œ í™•ì¸
    // 4. ì•Œë¦¼ ë°œì†¡ ë“±
}
```

## ğŸ“‹ êµ¬í˜„ ê°€ì´ë“œ

### 1. í”„ë¡œì íŠ¸ êµ¬ì¡°
```
src/test/java/com/example/spring/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ TestDataConfig.java      # í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¹Œë”
â”‚   â”œâ”€â”€ TestDataManager.java     # ì‹œë‚˜ë¦¬ì˜¤ ë§¤ë‹ˆì €
â”‚   â””â”€â”€ TestScenario.java        # ì‹œë‚˜ë¦¬ì˜¤ ì»¨í…Œì´ë„ˆ
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ *RepositoryTestV2.java   # ê°œì„ ëœ Repository í…ŒìŠ¤íŠ¸
â””â”€â”€ service/  
    â””â”€â”€ *ServiceTest.java        # ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ Service í…ŒìŠ¤íŠ¸
```

### 2. í…ŒìŠ¤íŠ¸ ì‘ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

#### âœ… Repository í…ŒìŠ¤íŠ¸
- [ ] @DataJpaTest + í•„ìš” êµ¬í˜„ì²´ë§Œ @Import
- [ ] TestDataBuilderë¡œ í•„ìš” ë°ì´í„°ë§Œ ìƒì„±
- [ ] ê³ ìœ  ì‹ë³„ì(íƒ€ì„ìŠ¤íƒ¬í”„) í™œìš©
- [ ] data.sql ë…ë¦½ì  ê²€ì¦

#### âœ… Service í…ŒìŠ¤íŠ¸  
- [ ] ì ì ˆí•œ TestScenario ì„ íƒ/ìƒì„±
- [ ] Mock vs ì‹¤ì œ Repository íŒë‹¨
- [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•œ í…ŒìŠ¤íŠ¸
- [ ] ë³µì¡í•œ ìƒíƒœ ì„¤ì •ì€ TestDataManager í™œìš©

#### âœ… í†µí•© í…ŒìŠ¤íŠ¸
- [ ] @SpringBootTest + @Transactional
- [ ] ComplexScenarioë¡œ ì¢…í•© ë°ì´í„° ì¤€ë¹„
- [ ] ì „ì²´ í”Œë¡œìš° ê²€ì¦
- [ ] ì„±ëŠ¥ ì˜í–¥ ìµœì†Œí™”

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### 1. í…ŒìŠ¤íŠ¸ ì•ˆì •ì„± í–¥ìƒ
- data.sql ë³€ê²½ì— ì˜í–¥ë°›ì§€ ì•ŠëŠ” ë…ë¦½ì  í…ŒìŠ¤íŠ¸
- ì˜ˆì¸¡ ê°€ëŠ¥í•˜ê³  ë°˜ë³µ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

### 2. í…ŒìŠ¤íŠ¸ ì‘ì„± íš¨ìœ¨ì„±
- ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì»´í¬ë„ŒíŠ¸
- ì‹œë‚˜ë¦¬ì˜¤ë³„ ìµœì í™”ëœ ë°ì´í„° ì¤€ë¹„

### 3. ìœ ì§€ë³´ìˆ˜ì„± ê°œì„ 
- í…ŒìŠ¤íŠ¸ ì˜ë„ê°€ ëª…í™•í•œ ì½”ë“œ
- ë°ì´í„° ë³€ê²½ ì‹œ ì˜í–¥ ë²”ìœ„ ìµœì†Œí™”

### 4. ìƒìœ„ ë„ë©”ì¸ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- ë³µì¡í•œ ì˜ì¡´ì„±ì„ ê°€ì§„ ë„ë©”ì¸ë„ ì‰½ê²Œ í…ŒìŠ¤íŠ¸
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì§‘ì¤‘í•œ í…ŒìŠ¤íŠ¸ ì‘ì„±

---

**ê²°ë¡ **: ì´ ì „ëµì„ í†µí•´ data.sqlê³¼ ë…ë¦½ì ì´ë©´ì„œë„ ì‹¤ìš©ì ì¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìœ¼ë©°, í…ŒìŠ¤íŠ¸ì˜ ì›ì‹œì„±ê³¼ ì‹ ë¢°ì„±ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.